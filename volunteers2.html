<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Volunteer Dashboard | RescueConnect</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
  .alert-card { margin: 15px 0; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); padding: 15px; background: #fff; }
  #map { height: 400px; width: 100%; border-radius: 10px; margin-bottom: 20px; }
  .status-box { margin-top: 20px; }
  .status-item { background: #f1f3f5; padding: 10px; border-left: 5px solid #28a745; margin-bottom: 8px; border-radius: 5px; }
</style>
</head>
<body>

<nav class="navbar navbar-dark bg-danger shadow">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold" href="#">🚑 RescueConnect</a>
  </div>
</nav>

<div class="container my-4">
  <h2 class="text-center text-danger mb-3">🆘 Incoming Victim Alerts</h2>
  <div id="alertsContainer"></div>

  <h4 class="mt-4">Live Rescue Map</h4>
  <div id="map"></div>

  <div class="status-box" id="statusBox">
    <h5 class="fw-bold">📢 Live Updates:</h5>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Leaflet (for Geoapify maps) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getDatabase, ref, onChildAdded, set, push } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyATW3DpocYyYSjB26Vs6FXVAraxChM9eX8",
  authDomain: "heart-ef738.firebaseapp.com",
  databaseURL: "https://heart-ef738-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "heart-ef738",
  storageBucket: "heart-ef738.firebasestorage.app",
  messagingSenderId: "909650774585",
  appId: "1:909650774585:web:b54ca3aa48b6ddbea55be8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const alertsRef = ref(db, 'victims');
const volunteersRef = ref(db, 'volunteers');

const alertsContainer = document.getElementById('alertsContainer');
const statusBox = document.getElementById('statusBox');

const GEOAPIFY_KEY = "020aae3b4d254578bfb32fc455ae3fb0";

// Initialize map
const map = L.map('map').setView([17.385044, 78.486671], 13);
L.tileLayer(`https://maps.geoapify.com/v1/tile/{id}/{z}/{x}/{y}.png?apiKey=${GEOAPIFY_KEY}`, {
    id: 'osm-bright',
    tileSize: 256,
    zoomOffset: 0
}).addTo(map);

let volunteerMarker;
let victimMarkers = [];

// Reverse geocoding function
async function fetchAddress(lat, lng) {
    const url = `https://api.geoapify.com/v1/geocode/reverse?lat=${lat}&lon=${lng}&apiKey=${GEOAPIFY_KEY}`;
    try {
        const res = await fetch(url);
        const data = await res.json();
        return data.features[0]?.properties?.formatted || "Unknown location";
    } catch (err) {
        console.error(err);
        return "Unknown location";
    }
}

// Calculate distance in km
function distanceKm(lat1, lon1, lat2, lon2) {
    const R = 6371; 
    const dLat = (lat2-lat1)*Math.PI/180;
    const dLon = (lon2-lon1)*Math.PI/180;
    const a = Math.sin(dLat/2)*Math.sin(dLat/2) + 
              Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) * 
              Math.sin(dLon/2)*Math.sin(dLon/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Get volunteer location
function startVolunteerTracking() {
    if (!navigator.geolocation) return alert("Geolocation not supported");
    navigator.geolocation.watchPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        if(volunteerMarker) volunteerMarker.setLatLng([lat, lng]);
        else volunteerMarker = L.marker([lat, lng], {icon: L.icon({iconUrl:"https://maps.google.com/mapfiles/ms/icons/green-dot.png", iconSize:[32,32]})}).addTo(map).bindPopup("You");

        // Update volunteer location in Firebase for victims
        const volunteerId = localStorage.getItem('volunteerId') || 'vol_' + Math.random().toString(36).slice(2);
        localStorage.setItem('volunteerId', volunteerId);
        set(ref(db, 'volunteers/' + volunteerId), {latitude: lat, longitude: lng, timestamp: new Date().toISOString()});

        // Check distance to each victim
        victimMarkers.forEach(vm => {
            const dist = distanceKm(lat, lng, vm.lat, vm.lng);
            if(dist <= 5) addStatus(`⚠️ You are within 5km of ${vm.name}'s location`);
        });
    }, err => console.error(err), { enableHighAccuracy: true });
}

// Display status messages
function addStatus(msg) {
    const div = document.createElement("div");
    div.className = "status-item";
    div.textContent = msg;
    statusBox.appendChild(div);
}

// Listen for new victims
onChildAdded(alertsRef, async (snapshot) => {
    const data = snapshot.val();
    const addr = await fetchAddress(data.latitude, data.longitude);

    // Add victim marker
    const marker = L.marker([data.latitude, data.longitude], {icon: L.icon({iconUrl:"https://maps.google.com/mapfiles/ms/icons/red-dot.png", iconSize:[32,32]})}).addTo(map);
    marker.bindPopup(`<b>${data.name || "Anonymous"}</b><br>${data.details || "No details"}<br>${addr}`);
    victimMarkers.push({marker, lat: data.latitude, lng: data.longitude, name: data.name || "Anonymous"});

    // Add alert card
    const card = document.createElement('div');
    card.className = 'alert-card';
    card.innerHTML = `<h5 class="text-danger">🚨 ${data.name || 'Anonymous'}</h5><p>${data.details || 'No description'}</p><p><strong>Address:</strong> ${addr}</p>`;
    alertsContainer.prepend(card);

    addStatus(`New alert from ${data.name || "Anonymous"}`);
});

// Start volunteer tracking
startVolunteerTracking();
</script>

</body>
</html>
